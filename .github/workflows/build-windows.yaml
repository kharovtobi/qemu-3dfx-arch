name: Build Windows

on:
  workflow_dispatch:

  push:
    branches: [ workflow ]
  pull_request:
    branches: [ workflow ]

jobs:

   
   Build-Windows:
   
     runs-on: windows-2019       
     env:
      pkgver: '9.1.0'
      patch:  '00-qemu91x-mesa-glide.patch'
      
     steps:  
     - name: Checkout repo
       uses: actions/checkout@v4
     - name: Setup MSYS2 (mingw32)
       uses: msys2/setup-msys2@v2
       with:
          msystem: MINGW32
          update: true
          install: >-
            base
            base-devel
            vim
            perl
            coreutils
            mingw-w64-i686-tools
            mingw-w64-i686-binutils
            mingw-w64-i686-gcc       

     - name: Adding Watcom support
     - shell: msys2 {0}
       run:  |
         wget https://github.com/open-watcom/open-watcom-v2/releases/download/Current-build/ow-snapshot.tar.xz
         mkdir watcom
         tar xf ow-snapshot.tar.xz -C watcom
         export WATCOM=$(pwd)/watcom
         export PATH=$WATCOM/binl64:$WATCOM/binl:$PATH
         export EDPATH=$WATCOM/eddat
         export INCLUDE=$WATCOM/lh

     - name: Adding djgpp support
     - shell: msys2 {0}
       run: |
         wget https://github.com/andrewwutw/build-djgpp/releases/download/v3.4/djgpp-mingw-gcc1220.zip
         unzip djgpp-mingw-gcc1220.zip
         mv djgpp/setenv djgpp/setenv.sh
         chmod +x djgpp/setenv.sh
         ./djgpp/setenv.sh
         
        
     - name: Build 3dfx wrappers
     - shell: msys2 {0}
       run: |
        cd wrappers/3dfx
        mkdir build && cd build
        dir
        bash ../../../scripts/conf_wrapper
        make && make clean

     - name: Build Mesa wrappers
     - shell: msys2 {0}
       run: |
        cd wrappers/mesa
        mkdir build && cd build
        dir
        bash ../../../scripts/conf_wrapper
        make && make clean
        
     - name: Uploading file
       uses: actions/upload-artifact@v4
       with:
        name: bin-wrappers-${{ env.pkgver }}-artifact
        path: ./wrappers

        

     

     


        
